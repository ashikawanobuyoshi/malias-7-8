import{O as ue,g as ce,r as b,k as $,p as de,N as me,n as O,l as J,c as r,a as t,A as N,t as c,s as h,F as S,y as V,q as p,v as x,z,j as pe,P as ve,o as i,Q as fe,R as ye,x as be}from"./C_xtq39S.js";import{u as ge}from"./byI3lozG.js";import{_ as he}from"./DlAUqK2U.js";import"./DqPHLXxX.js";const xe=ue("favorites",{state:()=>({favoriteImages:[]}),actions:{addFavorite(g){this.favoriteImages.push(g)},removeFavorite(g){this.favoriteImages.splice(g,1)}},persist:!0});function _e(g){try{return JSON.stringify(g)}catch(v){return console.error("シリアライズエラー:",v),"[]"}}function we(g){try{return JSON.parse(g)}catch(v){return console.error("デシリアライズエラー:",v),[]}}const ke=()=>({sendEmail:async v=>{try{return await $fetch("/api/send-email",{method:"POST",body:v})}catch(k){throw console.error("メール送信エラー:",k),k}}}),qe={key:0},Ie={key:1},$e={class:"pb-24"},Ne={class:"p-4 space-y-6"},Se={key:0,class:"space-y-4"},Ce={class:"text-2xl font-bold"},Ae=["src"],Te={class:"whitespace-pre-line"},Ve={class:"favorites-gallery"},Le={key:0,class:"text-gray-600"},Ue={key:1,class:"favorites-list flex flex-wrap gap-4"},je={class:"w-40 h-40 flex items-center justify-center bg-gray-50 rounded mb-3 border"},Ee=["src"],Me={class:"font-medium mb-2 text-center break-words w-full text-gray-700"},Pe={key:0,class:"w-full"},Fe={class:"block mb-2 w-full text-sm text-gray-700"},He=["onUpdate:modelValue"],Re={class:"block mb-2 w-full text-sm text-gray-700"},Oe=["onUpdate:modelValue"],Je={class:"mt-2 font-semibold text-gray-800 text-center w-full"},ze=["onClick"],Be=["onClick"],We={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"},Qe=["src"],Ge={class:"flex-1"},Xe={class:"flex items-start"},Ke=["onUpdate:modelValue","onChange"],Ye={class:"font-medium text-gray-800"},Ze=["innerHTML"],De={key:1,class:"mt-2 flex items-center space-x-2"},et=["onClick"],tt=["onUpdate:modelValue"],st=["onClick"],ot={class:"space-y-4 border p-4 rounded bg-gray-50"},lt={key:0,class:"mt-4 space-y-2"},at=["onClick"],nt={key:1,class:"mt-4 space-y-2"},rt=["onClick"],it={class:"font-bold"},ut={class:"space-y-2 pb-32"},ct={key:0,class:"text-green-600 font-semibold"},dt={key:1,class:"text-red-600 font-semibold"},mt={class:"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-50"},pt=["disabled"],vt=.1,ft=ce({__name:"[id]",async setup(g){let v,k;const P=ve(),L=pe(),_=b(!1),f=$(()=>{var e;return((e=P.params.id)==null?void 0:e.toString())??""});de(()=>{console.log("🧪 typeof productId:",typeof f),console.log("🧪 typeof productId.value:",typeof f.value),console.log("🧪 productId.value:",f.value),(!f.value||f.value==="undefined")&&(console.warn("Invalid product ID:",f.value),L.replace("/"))}),console.log("Product ID:",f.value);const{data:U}=([v,k]=me(()=>ge("product",()=>{const e=String(P.params.id??"");return $fetch(`/api/products/${e}`)})),v=await v,k(),v),B=()=>{window.history.length>1?L.back():L.push("/")},m=xe(),q=b([]),w=b([]),C=b({name:"商品名",price:0});O(()=>f.value,async e=>{if(!e){console.warn("productId is undefined or empty. Fetch skipped.");return}console.log("🧪 Fetch対象の productId:",e);try{const s=await $fetch(`/api/print-options?productId=${e}`);console.log("📦 print-options APIレスポンス:",s),q.value=s.map(o=>({...o,selected:!1,quantity:0}))}catch(s){console.error("❌ print-options の取得に失敗:",s)}},{immediate:!0}),J(()=>{const e=localStorage.getItem("favoriteImages");if(e)try{m.favoriteImages=we(e)}catch(s){console.error("復元失敗:",s)}}),O(()=>m.favoriteImages,e=>{localStorage.setItem("favoriteImages",_e(e))},{deep:!0});function j(e,s){const o={四つ切:5800,六切り:4800,キャビネ:3800,手札:3500};return!e||!s?0:o[e]*s}function W(e){if(!e.selectedType||!e.quantity||e.quantity<1){alert("プリント種類と枚数を正しく入力してください。");return}console.log("注文された画像:",e)}const Q=e=>{m.favoriteImages.splice(e,1)},G=e=>{e.selected&&e.quantity===0?e.quantity=1:e.selected||(e.quantity=0)},X=e=>{e.quantity++},K=e=>{e.quantity>1&&e.quantity--},A=$(()=>q.value.filter(e=>e.selected&&e.quantity>0));$(()=>A.value.reduce((e,s)=>e+s.price*s.quantity,0));const y=b({name:"",price:0,quantity:1,fileName:""}),Y=()=>{const e=y.value;e.fileName&&e.name.trim()!==""&&e.price>0&&e.quantity>0?(w.value.push({...e}),y.value={name:"",price:0,quantity:1,fileName:""}):alert("ファイル名、名前、価格、数量をすべて入力してください。")};b([]),J(async()=>{try{const e=await $fetch("/api/print-options",{params:{productId:f}});q.value=e.map(s=>({...s,quantity:1}))}catch(e){console.error("追加オプションの取得に失敗しました:",e)}});const E=$(()=>{const e=Array.isArray(m.favoriteImages)?m.favoriteImages.reduce((u,l)=>u+j(l.selectedType,l.quantity),0):0,s=(w.value??[]).reduce((u,l)=>u+l.price*l.quantity,0),o=(q.value??[]).reduce((u,l)=>l.selected&&l.quantity&&l.price?u+l.price*l.quantity:u,0);return e+s+o}),F=$(()=>Math.round(E.value*(1+vt))),{sendEmail:Z}=ke(),H=["info@syashin8.com"],d=b({customerName:"",email:"",address:"",comment:""}),M=b(!1),T=b(""),R=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,D=async e=>{console.log("🧪 orderDetails.images:",e==null?void 0:e.images);const s=[...e.address?[e.address]:[],...H],o="【注文確定】ご注文ありがとうございます",u=Array.isArray(e.items)&&e.items.length>0,l=Array.isArray(e.images)&&e.images.length>0;let I="";u?I=`
    <ul>
      ${e.items.map(a=>`
          <li>
            ${a.fileName?`ファイル名: ${a.fileName}<br>`:""}
            ${a.name||""} × ${a.quantity||1}：¥${(a.price||0).toLocaleString()}
          </li>
        `).join("")}
    </ul>
  `:l||(I="<p>画像の注文はありません。</p>");const n=Array.isArray(e.additionalItems)&&e.additionalItems.length?`
    <p><strong>【追加オプション】</strong></p>
    <ul>
      ${e.additionalItems.map(a=>`
          <li>${a.label} × ${a.quantity}：¥${(a.price*a.quantity).toLocaleString()}</li>
        `).join("")}
    </ul>
  `:"",oe=Array.isArray(e.customItems)&&e.customItems.length?`
    <p><strong>【カスタムアイテム】</strong></p>
    <ul>
      ${e.customItems.map(a=>`
          <li>
            ファイル名: ${a.fileName||"（ファイル名不明）"}<br>
            ${a.name||"（名称未設定）"} × ${a.quantity||1}：¥${((a.price||0)*(a.quantity||1)).toLocaleString()}
          </li>
        `).join("")}
    </ul>
  `:"",le=Array.isArray(e.images)&&e.images.length?`
    <p><strong>【お気に入り画像】</strong></p>
    <ul>
      ${e.images.map((a,ie)=>`<li>画像 ${ie+1}: <a href="${a.url}" target="_blank">${a.filename||a.url}</a></li>`).join("")}
    </ul>
  `:"",ae=e.comment?`<p>備考　お写真の貼り順等:<br>${e.comment.replace(/\n/g,"<br>")}</p>`:"",ne=`<p>合計（税込）: ¥${e.totalWithTax.toLocaleString()}</p>`,re=`
    <p>${e.customerName} 様、</p>
    <p>以下の内容でご注文を承りました：</p>
    ${I}
    ${n}
    ${oe}
    ${le}
    ${ne}
    ${ae}
    <p>ご利用ありがとうございました。</p>
  `;try{return await Promise.all(s.map(a=>Z({to:a,subject:o,html:re}))),{success:!0}}catch(a){return console.error("メール送信エラー:",a),a.response&&(console.error("Response data:",a.response.data),console.error("Response status:",a.response.status)),{success:!1,message:"メール送信に失敗しました。"}}},ee=async()=>{if(_.value)return;if(_.value=!0,!d.value.customerName||!d.value.email||!R.test(d.value.email)){alert("お名前と正しいメールアドレスを入力してください。"),_.value=!1;return}const e=m.favoriteImages.filter(n=>n.selectedType&&n.quantity>0).map(n=>({fileName:n.fileName,name:n.selectedType,quantity:n.quantity,price:j(n.selectedType,n.quantity)})),s=A.value.map(n=>({id:n.id,label:n.name,quantity:n.quantity,price:n.price})),o=w.value.map(n=>({fileName:n.fileName||"(ファイル名不明)",name:n.name||"(名称未設定)",quantity:n.quantity,price:n.price}));if([...e,...s,...o].length===0){alert("注文内容が空です。"),_.value=!1;return}const l={customerName:d.value.customerName,address:d.value.email,comment:d.value.comment,images:m.favoriteImages.map(n=>({filename:n.fileName,url:n.url})),customItems:o,additionalItems:s,total:E.value,totalWithTax:F.value};console.log("🧪 favoriteImages（送信前）:",JSON.stringify(m.favoriteImages,null,2)),console.log("🧪 orderDetails.images:",JSON.stringify(l.images,null,2));const I=await D(l);I.success?(M.value=!0,T.value="",alert("ご注文ありがとうございました。確認メールを送信しました。"),m.favoriteImages=[],w.value=[],q.value.forEach(n=>n.selected=!1),d.value={customerName:"",email:"",address:"",comment:""}):(M.value=!1,T.value=I.message||"メール送信に失敗しました。",alert("ご注文は受け付けましたが、確認メールの送信に失敗しました。")),_.value=!1},te=b(!1),se={email:"info@syashin8.com"};return H.includes(se.email)&&(te.value=!0,console.log("管理者モード")),(e,s)=>(i(),r(S,null,[N(U)?(i(),r("div",qe,[t("h1",null,c(N(U).productName),1),t("p",null,c(N(U).description),1)])):(i(),r("div",Ie,s[7]||(s[7]=[t("p",null,"商品情報を読み込み中です...",-1)]))),t("main",$e,[t("div",Ne,[t("button",{onClick:B,class:"px-4 py-2 bg-gray-200 rounded"}," ← 戻る "),C.value?(i(),r("div",Se,[t("h2",Ce,c(C.value.productName),1),t("img",{src:C.value.src,alt:"",class:"w-full max-w-sm rounded"},null,8,Ae),t("p",Te,c(C.value.description),1)])):h("",!0),t("div",Ve,[s[11]||(s[11]=t("h3",{class:"text-xl font-semibold mb-4 text-gray-800 border-b pb-2"}," 📷 お気に入り画像一覧 ",-1)),N(m).favoriteImages.length===0?(i(),r("div",Le," お気に入り画像はありません ")):(i(),r("div",Ue,[(i(!0),r(S,null,V(N(m).favoriteImages,(o,u)=>(i(),r("div",{key:u,class:"favorite-item border p-4 rounded shadow-sm w-60 flex flex-col items-center bg-white"},[t("div",je,[t("img",{src:o.url,alt:"お気に入り画像",class:"max-w-full h-auto object-contain rounded border"},null,8,Ee)]),t("p",Me," ファイル名: "+c(o.fileName),1),f.value==="1"?(i(),r("div",Pe,[t("label",Fe,[s[9]||(s[9]=t("span",{class:"block mb-1 font-semibold"},"プリント種類:",-1)),p(t("select",{"onUpdate:modelValue":l=>o.selectedType=l,class:"border rounded px-2 py-1 w-full"},s[8]||(s[8]=[ye('<option disabled value="" data-v-ee8bc17d>選択してください</option><option value="四つ切" data-v-ee8bc17d>四つ切</option><option value="六切り" data-v-ee8bc17d>六切り</option><option value="キャビネ" data-v-ee8bc17d>キャビネ</option><option value="手札" data-v-ee8bc17d>手札</option>',5)]),8,He),[[fe,o.selectedType]])]),t("label",Re,[s[10]||(s[10]=t("span",{class:"block mb-1 font-semibold"},"枚数:",-1)),p(t("input",{type:"number","onUpdate:modelValue":l=>o.quantity=l,min:"1",class:"border rounded px-2 py-1 w-full"},null,8,Oe),[[x,o.quantity,void 0,{number:!0}]])]),t("p",Je," 小計: ¥"+c(j(o.selectedType,o.quantity).toLocaleString()),1),t("button",{class:"mt-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 w-full",onClick:l=>W(o)}," 注文する ",8,ze)])):h("",!0),t("button",{onClick:l=>Q(u),class:"text-red-600 font-bold text-xl mt-4",title:"削除"}," × ",8,Be)]))),128))]))]),t("div",null,[s[18]||(s[18]=t("h3",{class:"text-lg font-semibold mt-6"},"オプション選択",-1)),t("div",We,[(i(!0),r(S,null,V(q.value,(o,u)=>(i(),r("div",{key:u,class:"flex items-center border p-2 rounded shadow-sm bg-white"},[o.image?(i(),r("img",{key:0,src:o.image,alt:"オプション画像",class:"w-20 h-20 object-contain mr-4"},null,8,Qe)):h("",!0),t("div",Ge,[t("label",Xe,[p(t("input",{type:"checkbox","onUpdate:modelValue":l=>o.selected=l,class:"mr-2 mt-1",onChange:l=>G(o)},null,40,Ke),[[be,o.selected]]),t("span",Ye,c(o.name)+"（+¥"+c(o.price.toLocaleString())+"） ",1)]),o.description?(i(),r("p",{key:0,class:"text-sm text-gray-600 mt-1",innerHTML:o.description},null,8,Ze)):h("",!0),o.selected?(i(),r("div",De,[t("button",{class:"px-2 py-1 bg-gray-200 rounded",onClick:l=>K(o)}," － ",8,et),p(t("input",{type:"number","onUpdate:modelValue":l=>o.quantity=l,min:"1",class:"w-16 text-center border rounded"},null,8,tt),[[x,o.quantity,void 0,{number:!0}]]),t("button",{class:"px-2 py-1 bg-gray-200 rounded",onClick:l=>X(o)}," ＋ ",8,st)])):h("",!0)])]))),128))]),t("div",ot,[t("div",null,[s[12]||(s[12]=t("label",{class:"block text-sm font-medium mb-1"},"ファイル名",-1)),p(t("input",{"onUpdate:modelValue":s[0]||(s[0]=o=>y.value.fileName=o),placeholder:"例: custom.jpg",class:"border p-2 w-full rounded"},null,512),[[x,y.value.fileName]])]),t("div",null,[s[13]||(s[13]=t("label",{class:"block text-sm font-medium mb-1"},"名前",-1)),p(t("input",{"onUpdate:modelValue":s[1]||(s[1]=o=>y.value.name=o),placeholder:"例: 特注アルバム",class:"border p-2 w-full rounded"},null,512),[[x,y.value.name]])]),t("div",null,[s[14]||(s[14]=t("label",{class:"block text-sm font-medium mb-1"},"価格（円）",-1)),p(t("input",{type:"number","onUpdate:modelValue":s[2]||(s[2]=o=>y.value.price=o),placeholder:"例: 12000",class:"border p-2 w-full rounded"},null,512),[[x,y.value.price,void 0,{number:!0}]])]),t("div",null,[s[15]||(s[15]=t("label",{class:"block text-sm font-medium mb-1"},"数量",-1)),p(t("input",{type:"number","onUpdate:modelValue":s[3]||(s[3]=o=>y.value.quantity=o),placeholder:"1",min:"1",class:"border p-2 w-full rounded"},null,512),[[x,y.value.quantity,void 0,{number:!0}]])]),t("button",{onClick:Y,class:"px-4 py-2 bg-blue-600 text-white rounded"}," カスタムアイテムを追加 ")]),A.value.length>0?(i(),r("div",lt,[s[16]||(s[16]=t("h4",{class:"text-lg font-semibold"},"追加済みオプション",-1)),(i(!0),r(S,null,V(A.value,(o,u)=>(i(),r("div",{key:u,class:"border p-2 rounded flex justify-between items-center"},[t("div",null,c(o.name)+" - ¥"+c(o.price.toLocaleString())+" × "+c(o.quantity),1),t("button",{onClick:()=>{o.selected=!1,o.quantity=0},class:"text-red-600 underline"}," 削除 ",8,at)]))),128))])):h("",!0),w.value.length>0?(i(),r("div",nt,[s[17]||(s[17]=t("h4",{class:"text-lg font-semibold"},"追加済みアイテム",-1)),(i(!0),r(S,null,V(w.value,(o,u)=>(i(),r("div",{key:u,class:"border p-2 rounded flex justify-between items-center"},[t("div",null,c(o.fileName||o.name)+" - ¥"+c(o.price.toLocaleString())+" × "+c(o.quantity),1),t("button",{onClick:l=>w.value.splice(u,1),class:"text-red-600 underline"}," 削除 ",8,rt)]))),128))])):h("",!0)]),t("div",null,[t("p",null,"合計金額（税抜）：¥"+c(E.value.toLocaleString()),1),t("p",it," 合計金額（税込）：¥"+c(F.value.toLocaleString()),1)])]),t("div",ut,[s[19]||(s[19]=t("h3",{class:"text-xl font-semibold"},"お客様情報",-1)),p(t("input",{"onUpdate:modelValue":s[4]||(s[4]=o=>d.value.customerName=o),placeholder:"お名前（必須）",class:z(["w-full border p-2 rounded",{"border-red-500":!d.value.customerName&&e.formTouched}])},null,2),[[x,d.value.customerName]]),p(t("input",{"onUpdate:modelValue":s[5]||(s[5]=o=>d.value.email=o),placeholder:"メールアドレス（必須）",class:z(["w-full border p-2 rounded",{"border-red-500":(!d.value.email||!R.test(d.value.email))&&e.formTouched}])},null,2),[[x,d.value.email]]),p(t("textarea",{"onUpdate:modelValue":s[6]||(s[6]=o=>d.value.comment=o),placeholder:"備考（例：お写真の貼る順番 1:左 2:中央 3:右）",class:"w-full border p-2 rounded h-24"},null,512),[[x,d.value.comment]]),M.value?(i(),r("p",ct," ご注文ありがとうございました！確認メールを送信しました。 ")):h("",!0),T.value?(i(),r("p",dt,c(T.value),1)):h("",!0)])]),t("div",mt,[t("button",{onClick:ee,disabled:_.value,class:"w-full px-4 py-3 bg-green-500 text-white rounded-lg font-semibold text-lg hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed"},c(_.value?"送信中...":"注文を確定する"),9,pt)])],64))}}),xt=he(ft,[["__scopeId","data-v-ee8bc17d"]]);export{xt as default};
